from fastapi.testclient import TestClient

from app.main import app

client = TestClient(app)


def test_list_sections_ok():
    """存在するマニュアル名でセクション一覧が取得できることを確認"""

    resp = client.get(
        "/list_sections",
        params={"manual_name": "給付金編"},
    )
    assert resp.status_code == 200

    data = resp.json()

    # 契約どおり manual / sections が必須であること
    assert isinstance(data, dict)
    assert "manual" in data
    assert "sections" in data

    assert data["manual"] == "給付金編"

    sections = data["sections"]
    assert isinstance(sections, list)
    assert len(sections) > 0
    assert all(isinstance(s, str) for s in sections)

    # 代表的なセクションIDが含まれていることを軽く確認
    # （ToC に依存するので、存在しない場合はこのアサーションは調整してよい）
    assert "01" in sections
    assert "03-1" in sections


def test_list_sections_not_found():
    """存在しないマニュアル名で 404 が返ることを確認"""

    resp = client.get(
        "/list_sections",
        params={"manual_name": "存在しないマニュアル"},
    )
    assert resp.status_code == 404

    data = resp.json()
    # FastAPI 標準の detail フィールドが返る想定
    assert "detail" in data